/*
 * To change this template, choose Tools | Templates
 * and open the template in the editor.
 */

/*
 * IndexingDialog.java
 *
 * Created on Sep 10, 2011, 9:01:08 AM
 */
package edu.coeia.indexing.dialogs;

import edu.coeia.cases.CaseFacade;
import edu.coeia.gutil.GuiUtil;
import edu.coeia.gutil.JTableUtil;
import edu.coeia.indexing.CrawlerIndexerThread;
import edu.coeia.util.ApplicationLogging;
import edu.coeia.util.FileUtil;

import java.awt.EventQueue;
import java.awt.event.WindowAdapter;
import java.awt.event.WindowEvent;

import java.io.File;
import java.io.IOException;

import java.util.logging.Level;
import java.util.logging.Logger;

import javax.swing.JProgressBar;
import javax.swing.JTable ;

/**
 *
 * @author wajdyessam
 */
public final class IndexingDialog extends javax.swing.JDialog {

    private final CaseFacade caseFacade;
    
    private final EmailCrawlingProgressPanel emailCrawlingPanel ;
    private final FileSystemCrawlingProgressPanel fileSystemCrawlingPanel;
    
    private final static String EMAIL_PANEL = "EMAIL";
    private final static String FILE_PANEL = "FILE";
    
    private CrawlerIndexerThread indexerThread ;
    private boolean loggingAppearanceFlag;
    
    private final static Logger logger = ApplicationLogging.getLogger();
    
    /** Creates new form IndexingDialog */
    public IndexingDialog(java.awt.Frame parent, boolean modal,
            final CaseFacade caseFacade, boolean startIndexNow) {
        
        super(parent, modal);
        initComponents();
        
        this.emailCrawlingPanel = new EmailCrawlingProgressPanel();
        this.fileSystemCrawlingPanel = new FileSystemCrawlingProgressPanel();
        this.caseFacade = caseFacade;
        
        this.addCardsPanel();
        GuiUtil.showPanel(FILE_PANEL, this.objectPanel);
        
        this.hideLoggingPanel();
        this.resettingButtons(true);
        
        this.closeCralwingWhenCloseTheWindow();
        
        if ( startIndexNow ) {
            this.startCrawling();
        }
    }

    private void addCardsPanel() {
        this.objectPanel.add(this.emailCrawlingPanel, EMAIL_PANEL);
        this.objectPanel.add(this.fileSystemCrawlingPanel, FILE_PANEL);
    }
    
    private void hideLoggingPanel() {
        this.loggingAppearanceFlag = false;
        this.showLoggingPanel(this.loggingAppearanceFlag);
        this.pack();
    }
    
    private void closeCralwingWhenCloseTheWindow() {
        this.addWindowListener( new WindowAdapter() {
            @Override
            public void windowClosed (WindowEvent event){
                try {
                    stopIndexerThread();
                    hideIndexingDialog();
                } catch (IOException ex) {
                    logger.log(Level.SEVERE, null, ex);
                }
            }
        });
    }
    
    private void startCrawling() {
       try {
            startIndexerThread();
        } catch (IOException ex) {
            logger.log(Level.SEVERE, null, ex);
        }
    }
    
    /** This method is called from within the constructor to
     * initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is
     * always regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        indexPanel = new javax.swing.JPanel();
        objectPanel = new javax.swing.JPanel();
        progressStatusPanel = new javax.swing.JPanel();
        bigSizeMsgLbl = new javax.swing.JLabel();
        progressBar = new javax.swing.JProgressBar();
        jLabel27 = new javax.swing.JLabel();
        numberOfFilesLbl = new javax.swing.JLabel();
        jLabel41 = new javax.swing.JLabel();
        numberOfErrorFilesLbl = new javax.swing.JLabel();
        indexControlPanel = new javax.swing.JPanel();
        startIndexButton = new javax.swing.JButton();
        stopIndexingButton = new javax.swing.JButton();
        displayLoggingButton = new javax.swing.JButton();
        loggingPanel = new javax.swing.JPanel();
        jScrollPane1 = new javax.swing.JScrollPane();
        indexTable = new javax.swing.JTable();

        setDefaultCloseOperation(javax.swing.WindowConstants.DISPOSE_ON_CLOSE);
        setTitle("Case Indexing Window");

        indexPanel.setBorder(javax.swing.BorderFactory.createTitledBorder(""));
        indexPanel.setMaximumSize(new java.awt.Dimension(550, 2147483647));
        indexPanel.setLayout(new javax.swing.BoxLayout(indexPanel, javax.swing.BoxLayout.PAGE_AXIS));

        objectPanel.setLayout(new java.awt.CardLayout());
        indexPanel.add(objectPanel);

        progressStatusPanel.setBorder(javax.swing.BorderFactory.createTitledBorder(null, "Index Case", javax.swing.border.TitledBorder.DEFAULT_JUSTIFICATION, javax.swing.border.TitledBorder.DEFAULT_POSITION, new java.awt.Font("Tahoma", 1, 11))); // NOI18N
        progressStatusPanel.setLayout(new javax.swing.BoxLayout(progressStatusPanel, javax.swing.BoxLayout.PAGE_AXIS));

        bigSizeMsgLbl.setFont(new java.awt.Font("Tahoma", 1, 11)); // NOI18N
        bigSizeMsgLbl.setForeground(new java.awt.Color(255, 0, 0));
        bigSizeMsgLbl.setText(" ");
        progressStatusPanel.add(bigSizeMsgLbl);
        progressStatusPanel.add(progressBar);

        jLabel27.setFont(new java.awt.Font("Tahoma", 1, 11)); // NOI18N
        jLabel27.setText("Number of Items in Index:");
        progressStatusPanel.add(jLabel27);

        numberOfFilesLbl.setFont(new java.awt.Font("Tahoma", 1, 11)); // NOI18N
        numberOfFilesLbl.setForeground(new java.awt.Color(0, 0, 255));
        numberOfFilesLbl.setText(" ");
        progressStatusPanel.add(numberOfFilesLbl);

        jLabel41.setFont(new java.awt.Font("Tahoma", 1, 11)); // NOI18N
        jLabel41.setText("Number of Items Cannot Indexed:");
        progressStatusPanel.add(jLabel41);

        numberOfErrorFilesLbl.setFont(new java.awt.Font("Tahoma", 1, 11)); // NOI18N
        numberOfErrorFilesLbl.setForeground(new java.awt.Color(0, 0, 255));
        numberOfErrorFilesLbl.setText(" ");
        progressStatusPanel.add(numberOfErrorFilesLbl);

        indexPanel.add(progressStatusPanel);

        indexControlPanel.setBorder(javax.swing.BorderFactory.createTitledBorder(""));

        startIndexButton.setFont(new java.awt.Font("Tahoma", 1, 11));
        startIndexButton.setIcon(new javax.swing.ImageIcon(getClass().getResource("/edu/coeia/main/resources/new-edit-find-replace.png"))); // NOI18N
        startIndexButton.setText("Start Indexing");
        startIndexButton.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                startIndexButtonActionPerformed(evt);
            }
        });
        indexControlPanel.add(startIndexButton);

        stopIndexingButton.setFont(new java.awt.Font("Tahoma", 1, 11));
        stopIndexingButton.setIcon(new javax.swing.ImageIcon(getClass().getResource("/edu/coeia/main/resources/cancel.png"))); // NOI18N
        stopIndexingButton.setText("Stop Indexing");
        stopIndexingButton.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                stopIndexingButtonActionPerformed(evt);
            }
        });
        indexControlPanel.add(stopIndexingButton);

        displayLoggingButton.setFont(new java.awt.Font("Tahoma", 1, 11));
        displayLoggingButton.setIcon(new javax.swing.ImageIcon(getClass().getResource("/edu/coeia/main/resources/1274599246_text-x-log.png"))); // NOI18N
        displayLoggingButton.setText("Display Logging");
        displayLoggingButton.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                displayLoggingButtonActionPerformed(evt);
            }
        });
        indexControlPanel.add(displayLoggingButton);

        indexPanel.add(indexControlPanel);

        loggingPanel.setBorder(javax.swing.BorderFactory.createTitledBorder(null, "logging", javax.swing.border.TitledBorder.DEFAULT_JUSTIFICATION, javax.swing.border.TitledBorder.DEFAULT_POSITION, new java.awt.Font("Tahoma", 1, 11))); // NOI18N
        loggingPanel.setLayout(new java.awt.BorderLayout());

        jScrollPane1.setPreferredSize(new java.awt.Dimension(452, 100));

        indexTable.setAutoCreateRowSorter(true);
        indexTable.setModel(new javax.swing.table.DefaultTableModel(
            new Object [][] {

            },
            new String [] {
                "Item Type", "Item Data", "Error Message"
            }
        ) {
            Class[] types = new Class [] {
                java.lang.String.class, java.lang.String.class, java.lang.String.class
            };
            boolean[] canEdit = new boolean [] {
                false, false, false
            };

            public Class getColumnClass(int columnIndex) {
                return types [columnIndex];
            }

            public boolean isCellEditable(int rowIndex, int columnIndex) {
                return canEdit [columnIndex];
            }
        });
        indexTable.setFillsViewportHeight(true);
        jScrollPane1.setViewportView(indexTable);

        loggingPanel.add(jScrollPane1, java.awt.BorderLayout.CENTER);

        indexPanel.add(loggingPanel);

        getContentPane().add(indexPanel, java.awt.BorderLayout.CENTER);

        pack();
    }// </editor-fold>//GEN-END:initComponents

    private void startIndexButtonActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_startIndexButtonActionPerformed
        try {
            startIndexerThread();
        } catch (IOException ex) {
            logger.log(Level.SEVERE, null, ex);
        }
    }//GEN-LAST:event_startIndexButtonActionPerformed

    private void stopIndexingButtonActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_stopIndexingButtonActionPerformed
        try {
            stopIndexerThread();
        } catch (IOException ex) {
            logger.log(Level.SEVERE, null, ex);
        }
    }//GEN-LAST:event_stopIndexingButtonActionPerformed

    private void displayLoggingButtonActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_displayLoggingButtonActionPerformed
        this.loggingAppearanceFlag = !loggingAppearanceFlag;
        this.showLoggingPanel(loggingAppearanceFlag);
    }//GEN-LAST:event_displayLoggingButtonActionPerformed
   
    public void hideIndexingDialog() {
        this.dispose();
    }
    
    /**
     * Update the GUI label
     * 
     * this code can be work from EDT and other Threads
     * 
     * @param numberOfItemsIndexed
     * @param noItemsCannotIndexed 
     */
    public void updateLabel(final int numberOfItemsIndexed, final int noItemsCannotIndexed,
            final String bigSizeMessage) {
        Runnable task = new Runnable() {
          @Override
          public void run() {
              numberOfFilesLbl.setText(String.valueOf(numberOfItemsIndexed));
              numberOfErrorFilesLbl.setText(String.valueOf(noItemsCannotIndexed));
              bigSizeMsgLbl.setText(bigSizeMessage);
          }
        };
        
        if ( EventQueue.isDispatchThread() )
            task.run();
        else
            EventQueue.invokeLater(task);
    }
    
    /**
     * Change the current panel in card to file system crawling panel
     * this method can be called form any methods including EDT
     * 
     * @param data 
     */
    public void showFileSystemPanel(final FileSystemCrawlingProgressPanel.FileSystemCrawlerData data) {
        Runnable task = new Runnable() { 
            @Override
            public void run() {
                fileSystemCrawlingPanel.setCurrentFile(data.getFileName());
                fileSystemCrawlingPanel.setFileExtension(data.getFileExtension());
                fileSystemCrawlingPanel.setFileSize(data.getFileSize());
                fileSystemCrawlingPanel.setFileDate(data.getFileDate());
                fileSystemCrawlingPanel.setEmbeddedDocuments(data.getEmbeddedDocuments());
                GuiUtil.showPanel(FILE_PANEL, objectPanel);
            }
        };
        
        if ( EventQueue.isDispatchThread())
            task.run();
        else
            EventQueue.invokeLater(task);
    }
    
    // called from other threads, must workin on EDT
    public void showEmailPanel(final EmailCrawlingProgressPanel.EmailCrawlingData data) {
        EventQueue.invokeLater(new Runnable() {
            @Override
            public void run() {
                emailCrawlingPanel.setAgentType(data.getAgentType());
                emailCrawlingPanel.setCurrentFolder(data.getCurrentFolder());
                emailCrawlingPanel.setCurrentMessageSubject(data.getSubject());
                emailCrawlingPanel.setMessageDate(data.getDate());
                emailCrawlingPanel.setHasAttachment(data.getHasAttachment());
                emailCrawlingPanel.setFrom(data.getFrom());
                emailCrawlingPanel.setTo(data.getTo());
                emailCrawlingPanel.setAttachment(data.getAttachments());
                GuiUtil.showPanel(EMAIL_PANEL, objectPanel);
            }
        });
    }
    
    /**
     * Add Error Message to table
     * 
     * this method can be called from other thread or EDT thread
     * so it check if its not in EDT then add the task in the EDT
     * 
     * @param filePath
     * @param message 
     */
    public void addErrorMessage(final File filePath, final String message) {
        Runnable task = new Runnable() { 
            @Override
            public void run() {
                Object[] data = { 
                    FileUtil.getExtension(filePath.getPath()), 
                    filePath.getPath(), 
                    message
                };
                
                JTableUtil.addRowToJTable(getLoggingTable(), data);    
            }
        };
        
        if ( EventQueue.isDispatchThread() )
            task.run();
        else
            EventQueue.invokeLater(task);
    }
   
    public CaseFacade getCaseFacade() { return this.caseFacade; }
    public JTable getLoggingTable () { return this.indexTable; }
    public JProgressBar getProgressBar() { return this.progressBar ; }
    public void setNumberOfFiles(final String no) { this.numberOfFilesLbl.setText(no); }
    public void setNumberOfFilesError(final String no) { this.numberOfErrorFilesLbl.setText(no); }
    public void setprogressBar(final int value) { this.progressBar.setValue(value); }
    public void setBigSizeLabel(final String text) { this.bigSizeMsgLbl.setText(text); }
    public void setProgressIndetermined(final boolean status) { this.progressBar.setIndeterminate(status); }
    public void setStartButtonStatus(final boolean status) { this.startIndexButton.setEnabled(status); }
    public void setStopButtonStatus(final boolean status) { this.stopIndexingButton.setEnabled(status); }
    
    
    public void clearFields() {
        assert EventQueue.isDispatchThread();
        this.setBigSizeLabel("");
        this.setprogressBar(0);
        this.getProgressBar().setStringPainted(false);
        this.setProgressIndetermined(false);
        this.setStartButtonStatus(true);
        this.setStopButtonStatus(false);
    }
    
    private void showLoggingPanel(boolean flag) {
        this.loggingPanel.setVisible(flag);
    }
    
    private void startIndexerThread () throws IOException{
        resettingButtons(false);
        JTableUtil.removeAllRows(indexTable);

        // starting thread
        indexerThread = new CrawlerIndexerThread(this);
        indexerThread.execute();
    }
    
    private void stopIndexerThread() throws IOException {
        if ( indexerThread != null) {
            this.clearFields();
            indexerThread.stopIndexingThread();
        }
    }
    
    private void resettingButtons(boolean state) {
        startIndexButton.setEnabled(state);
        stopIndexingButton.setEnabled(!state);
    }
    
    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JLabel bigSizeMsgLbl;
    private javax.swing.JButton displayLoggingButton;
    private javax.swing.JPanel indexControlPanel;
    private javax.swing.JPanel indexPanel;
    private javax.swing.JTable indexTable;
    private javax.swing.JLabel jLabel27;
    private javax.swing.JLabel jLabel41;
    private javax.swing.JScrollPane jScrollPane1;
    private javax.swing.JPanel loggingPanel;
    private javax.swing.JLabel numberOfErrorFilesLbl;
    private javax.swing.JLabel numberOfFilesLbl;
    private javax.swing.JPanel objectPanel;
    private javax.swing.JProgressBar progressBar;
    private javax.swing.JPanel progressStatusPanel;
    private javax.swing.JButton startIndexButton;
    private javax.swing.JButton stopIndexingButton;
    // End of variables declaration//GEN-END:variables
}
